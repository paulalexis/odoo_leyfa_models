<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- ========== ACTIONS ========== -->
    <record id="action_rail_measurement" model="ir.actions.act_window">
        <field name="name">Mesures de voie</field>
        <field name="res_model">rail.measurement</field>
        <!-- On ajoute 'calendar' ici -->
        <field name="view_mode">list,calendar,form</field>
    </record>

    <!-- ========== WIZARD: Cr√©ation de mesure ========== -->
    <record id="view_rail_measurement_wizard_form" model="ir.ui.view">
        <field name="name">rail.measurement.wizard.form</field>
        <field name="model">rail.measurement.wizard</field>
        <field name="arch" type="xml">
            <form string="Associer une mesure">
                <sheet>
                    <group>
                        <field name="mode" widget="radio"/>
                        <field name="partner_id" invisible="1"/>
                        <field name="sale_order_id" invisible="1"/>
                    </group>
                    
                    <!-- This part is only visible if 'Link' is selected -->
                    <group invisible="mode != 'link'">
                        <field name="measurement_id" 
                            options="{'no_create': True}" 
                            required="mode == 'link'"
                            placeholder="S√©lectionnez une mesure d√©j√† cr√©√©e..."/>
                    </group>

                    <!-- Helpful note for 'Create' mode -->
                    <div class="alert alert-info" role="alert" invisible="mode != 'create'">
                        <i class="fa fa-info-circle mr-1"/>
                        En cliquant sur <b>Valider</b>, le formulaire complet de configuration LEYFA s'ouvrira dans une nouvelle fen√™tre.
                    </div>
                </sheet>
                <footer>
                    <button name="action_apply" string="Valider" type="object" class="btn-primary"/>
                    <button string="Annuler" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- ========== WIZARD: Ligne d'affectation de chariot ========== -->
    <!-- <record id="view_assign_chariot_line_list" model="ir.ui.view">
        <field name="name">rail.measurement.assign.chariot.line.wizard.list</field>
        <field name="model">rail.measurement.assign.chariot.line.wizard</field>
        <field name="arch" type="xml">
            <list editable="bottom">
                <field name="chariot_type_id" readonly="1"/>
                <field name="chariot_id" 
                       domain="[('cart_type_id', '=', chariot_type_id), ('state', '=', 'available')]"
                       options="{'no_create': True}"/>
            </list>
        </field>
    </record> -->

    <!-- ========== WIZARD: Affectation des chariots ========== -->
    <!-- <record id="view_rail_measurement_assign_chariot_wizard_form" model="ir.ui.view">
        <field name="name">rail.measurement.assign.chariot.wizard.form</field>
        <field name="model">rail.measurement.assign.chariot.wizard</field>
        <field name="arch" type="xml">
            <form string="Affecter les chariots physiques">
                <sheet>
                    <group>
                        <field name="measurement_id" readonly="1"/>
                    </group>

                    <separator string="Besoins d√©finis au devis"/>
                    <field name="chariot_type_lines" readonly="1">
                        <list>
                            <field name="chariot_type_id"/>
                            <field name="quantity"/>
                        </list>
                    </field>

                    <separator string="Affecter les chariots physiques" class="mt-3"/>
                    <field name="assignment_line_ids" nolabel="1"/>
                </sheet>

                <footer>
                    <button name="action_assign" string="Affecter" type="object" class="btn-primary"/>
                    <button string="Annuler" special="cancel"/>
                </footer>
            </form>
        </field>
    </record> -->

    <!-- ========== VIEWS: Rail Measurement ========== -->
    <record id="view_rail_measurement_list" model="ir.ui.view">
        <field name="name">rail.measurement.list</field>
        <field name="model">rail.measurement</field>
        <field name="arch" type="xml">
            <list string="Mesures de voie" 
                  decoration-info="state=='presale'" 
                  decoration-warning="state in ('production', 'measure', 'study', 'invoicing')" 
                  decoration-success="state=='done'"
                  decoration-danger="state=='cancelled'">
                <field name="reference"/>
                <field name="partner_id"/>
                <field name="date_start"/>
                <field name="ligne_id"/>
                <field name="pk_initial"/>
                <field name="pk_final"/>
                <field name="state" widget="badge" 
                       decoration-info="state == 'presale'"
                       decoration-warning="state in ('production', 'measure', 'study', 'invoicing')"
                       decoration-success="state == 'done'"
                       decoration-danger="state == 'cancelled'"/>
            </list>
        </field>
    </record>

    <record id="view_rail_measurement_form" model="ir.ui.view">
        <field name="name">rail.measurement.form</field>
        <field name="model">rail.measurement</field>
        <field name="arch" type="xml">
            <form string="Mesure de voie">
                <header>
                    <!-- Buttons and Statusbar remain here -->
                    <button name="action_confirm_fiche_mission" string="Confirmer la fiche mission" type="object" invisible="state != 'production' or prod_substate != 'mission'" class="oe_highlight"/>
                    <button name="action_validate_assignment" string="Valider l'affectation" type="object" invisible="state != 'production' or prod_substate != 'material'" class="oe_highlight"/>
                    <button name="action_modifier_fiche" string="Modifier la fiche de mission" type="object" invisible="state != 'production' or prod_substate != 'material'"/>
                    <button name="action_demande_mat√©riel" string="Demande mat√©riel" type="object" invisible="state != 'production' or prod_substate != 'material'"/>
                    <button name="action_mat√©riel_recu" string="Mat√©riel disponible" type="object" invisible="state != 'production' or prod_substate != 'urgence'" class="oe_highlight"/>
                    <!-- <button name="action_done" string="Terminer" type="object" invisible="state != 'in_progress'" class="oe_highlight"/> -->
                    <!-- <button name="action_done" string="Terminer" type="object" class="oe_highlight"/> -->
                    <button name="action_cancel" string="Annuler la mesure" type="object" invisible="state not in ['presale', 'confirmed', 'planned', 'in_progress']"/>
                    <button name="action_reset_to_draft" string="Remettre en pr√©-vente" type="object" invisible="state != 'cancelled'"/>
                    <field name="state" widget="statusbar" statusbar_visible="presale,production,measure,study,invoicing,done"/>
                </header>
                <sheet>
                    <!-- Identification Header: Only the essential "Who" -->
                    <div class="oe_title">
                        <div class="text-muted fst-italic small">
                            <field name="reference" readonly="1" nolabel="1"/>
                        </div>
                        <label for="partner_id" string="Client"/>
                        <h2 class="d-flex">
                            <field name="partner_id" placeholder="Nom du client..." readonly="state != 'presale'"/>
                        </h2>
                    </div>

                    <notebook>
                        <!-- TAB 1: SALES / COMMERCE -->
                        <page string="üíº Affaire &amp; Commerce" name="sales_tab">
                        </page>

                        <!-- TAB 2: PRODUCTION / TERRAIN -->
                        <page string="üó∫Ô∏è Planification" name="planification_tab">
                        </page>

                        <page string="üöß Relev√©s Terrain" name="terrain_tab">
                        </page>

                        <!-- TAB 3: √âTUDES & RAPPORTS -->
                        <page string="üî¨ √âtudes &amp; Livrables" name="studies_tab">
                            <separator string="RAPPORT D'INTERVENTION"/>
                            <field name="report" widget="html" placeholder="Saisissez ici les conclusions de l'√©tude..."/>
                            <separator string="NOTES INTERNES"/>
                            <field name="notes" placeholder="Notes diverses, incidents terrain..."/>
                        </page>

                        <!-- TAB 4: PROCESS VISUALISATION -->
                        <page string="‚öôÔ∏è Visualisation du processus" name="process_tab">
                            <group>
                                <group string="Configuration">
                                    <field name="view_level" widget="selection"/>
                                    <field name='show_chatter' widget="boolean_toggle"/>
                                    <!-- <field name="urgent_material_needed" widget="boolean_toggle" invisible="state != 'production'"/> -->
                                </group>
                                <group string="Sous-√©tapes">
                                    <field name="sale_substate" invisible="state != 'presale'" readonly="1"/>
                                    <field name="prod_substate" invisible="state != 'production'" readonly="1"/>
                                    <field name="measure_substate" invisible="state != 'measure'" readonly="1"/>
                                    <field name="study_substate" invisible="state != 'study'" readonly="1"/>
                                </group>
                            </group>
                            <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                                <field name="mermaid_graph" widget="mermaid" nolabel="1"/>
                                <div class="mt-1" invisible="not state_tip">
                                    <field name="state_tip" nolabel="1"/>
                                </div>
                            </div>
                        </page>
                    </notebook>
                </sheet>
                <chatter invisible="not show_chatter"/>
            </form>
        </field>
    </record>

    <!-- ========== PRODUCT TEMPLATE VIEWS ========== -->
    <record id="product_template_form_view_rail" model="ir.ui.view">
        <field name="name">product.template.form.rail</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                <page string="Mesure Ferroviaire" name="rail_measurement">
                    <group>
                        <!-- <group>
                            <field name="is_rail_measurement"/>
                        </group> -->
                    </group>

                    <separator string="Suivi des prestations" class="mt-4"/>
                    
                    <div class="alert alert-info" role="alert">
                        <div class="d-flex align-items-center justify-content-between">
                            <button name="action_view_rail_measurements" 
                                    type="object" 
                                    string="Voir les mesures" 
                                    class="btn btn-primary btn-sm"
                                    icon="fa-list"/>
                        </div>
                    </div>
                </page>
            </xpath>
        </field>
    </record>

    <!-- ========== SALE ORDER VIEWS ========== -->
    <record id="view_order_form_rail_custom" model="ir.ui.view">
        <field name="name">sale.order.form.rail.top.button</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='sale_order_template_id']" position="after">
                <label for="measurement_id" string="Mesure associ√©e"/>
                <div class="o_row w-100">
                    <!-- Bouton Cr√©er (visible si vide) -->
                    <button name="action_create_rail_measurement" 
                            string="Associer une mesure" 
                            type="object" 
                            icon="fa-train" 
                            class="btn-secondary"
                            invisible="measurement_id != False"/>

                    <!-- Champ ID (visible si rempli) -->
                    <field name="measurement_id" 
                        invisible="measurement_id == False" 
                        readonly="1"/>

                    <!-- Bouton Actualiser (visible si rempli, pouss√© √† droite) -->
                    <button name="action_update_sale_order_from_measurement" 
                            string="Actualiser devis" 
                            type="object" 
                            icon="fa-refresh" 
                            class="btn-secondary ms-auto" 
                            confirm="Attention, cette action √©crasera toutes les lignes entr√©es manuellement. √ätes-vous s√ªr ?"
                            invisible="measurement_id == False"/>
                    <button name="action_remove_measurement" 
                            string="D√©tacher" 
                            type="object" 
                            icon="fa-trash" 
                            class="btn-secondary ms-auto" 
                            confirm="Attention, cette action supprimera toutes les lignes entr√©es manuellement. √ätes-vous s√ªr ?"
                            invisible="measurement_id == False"/>
                </div>
            </xpath>
        </field>
    </record>

    <!-- ========== CHARIOT VIEWS ========== -->
    <record id="view_chariot_list" model="ir.ui.view">
        <field name="name">chariot.list</field>
        <field name="model">chariot</field>
        <field name="arch" type="xml">
            <list string="Chariots" 
                  decoration-success="state=='available'" 
                  decoration-danger="state=='out_of_service'" 
                  decoration-warning="state=='maintenance'">
                <field name="name"/>
                <field name="cart_type_id"/>
                <field name="serial_number"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'available'"
                       decoration-warning="state == 'maintenance'"
                       decoration-danger="state == 'out_of_service'"/>
            </list>
        </field>
    </record>

    <record id="view_chariot_form" model="ir.ui.view">
        <field name="name">chariot.form</field>
        <field name="model">chariot</field>
        <field name="arch" type="xml">
            <form string="Chariot">
                <header>
                    <field name="state" widget="statusbar" options="{'clickable': '1'}"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" 
                                name="action_view_calendar" 
                                icon="fa-calendar">
                            <div class="o_stat_info">
                                <span class="o_stat_text">Planning</span>
                            </div>
                        </button>
                    </div>

                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1><field name="name" placeholder="Ex: Chariot A-12"/></h1>
                    </div>
                    <group>
                        <group>
                            <field name="cart_type_id"/>
                            <field name="serial_number"/>
                        </group>
                        <group>
                            <field name="active" widget="boolean_toggle"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Historique des mesures">
                            <field name="measurement_ids" readonly="1">
                                <list>
                                    <field name="reference"/>
                                    <field name="date_start"/>
                                    <field name="state"/>
                                </list>
                            </field>
                        </page>
                        <page string="Notes">
                            <field name="notes"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_chariot" model="ir.actions.act_window">
        <field name="name">Chariots</field>
        <field name="res_model">chariot</field>
        <field name="view_mode">list,form</field>
    </record>

    <!-- ========== CHARIOT TYPE VIEWS ========== -->
    <record id="view_chariot_type_list" model="ir.ui.view">
        <field name="name">chariot.type.list</field>
        <field name="model">chariot.type</field>
        <field name="arch" type="xml">
            <list string="Types de chariots">
                <field name="name" string="Type de chariot"/>
                <field name="manufacturer"/>
            </list>
        </field>
    </record>

    <record id="view_chariot_type_form" model="ir.ui.view">
        <field name="name">chariot.type.form</field>
        <field name="model">chariot.type</field>
        <field name="arch" type="xml">
            <form string="Type de chariot">
                <sheet>
                    <group>
                        <field name="name"/>
                        <field name="manufacturer"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_chariot_type" model="ir.actions.act_window">
        <field name="name">Types de chariots</field>
        <field name="res_model">chariot.type</field>
        <field name="view_mode">list,form</field>
    </record>

    <record id="view_rail_measurement_calendar" model="ir.ui.view">
        <field name="name">rail.measurement.calendar</field>
        <field name="model">rail.measurement</field>
        <field name="arch" type="xml">
            <calendar string="Planning des mesures" 
                  date_start="date_start" 
                  date_stop="date_end"
                  color="state"
                  mode="month"
                  event_open_popup="true"
                  quick_create="0">
                <field name="reference"/>
                <field name="partner_id"/>
                <field name="state" widget="badge"/>
                <field name="assigned_chariot_ids" widget="many2many_tags" invisible="prod_substate != 'assigned'"/>
            </calendar>
        </field>
    </record>

    <record id="view_rail_urgent_assignment_wizard_form" model="ir.ui.view">
        <field name="name">rail.urgent.assignment.wizard.form</field>
        <field name="model">rail.urgent.assignment.wizard</field>
        <field name="arch" type="xml">
            <form string="Demande Urgente">
                <div class="alert alert-warning" role="alert">
                    <field name="message"/>
                </div>
                <footer>
                    <button name="action_confirm" string="Oui, passer en Urgence" type="object" class="btn-primary"/>
                    <button string="Non, corriger l'affectation" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>


    <!-- Importation Wizard -->
    <record id="view_rail_file_import_wizard_form" model="ir.ui.view">
        <field name="name">rail.file.import.wizard.form</field>
        <field name="model">rail.file.import.wizard</field>
        <field name="arch" type="xml">
            <form string="Importation de fichier de mesure">
                <!-- √âTAPE 1 : UPLOAD -->
                <div invisible="state != 'upload'">
                    <p class="text-muted">S√©lectionnez le fichier g√©n√©r√© par le logiciel embarqu√© (.lx ou .txt).</p>
                    <group>
                        <field name="file" filename="file_name" string="Fichier de mesure"/>
                        <field name="file_name" invisible="1"/>
                        <field name="state" invisible="1"/>
                    </group>
                </div>

                <!-- √âTAPE 2 : S√âLECTION (Si doublons de PK/Ligne) -->
                <div invisible="state != 'select'">
                    <div class="alert alert-warning" role="alert">
                        Plusieurs mesures correspondent aux crit√®res du fichier. Veuillez choisir la bonne :
                    </div>
                    <group>
                        <field name="selected_measurement_id" 
                            options="{'no_create': True}" 
                            domain="[('id', 'in', match_ids)]"
                            widget="selection"/>
                        <field name="match_ids" invisible="1"/>
                    </group>
                </div>

                <footer>
                    <button name="action_analyze" string="Analyser et Attacher" 
                            type="object" class="btn-primary" invisible="state != 'upload'"/>
                    <button name="action_confirm_selection" string="Confirmer l'attribution" 
                            type="object" class="btn-primary" invisible="state != 'select'"/>
                    <button string="Annuler" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="view_rail_measurement_consistance_line_list" model="ir.ui.view">
        <field name="name">rail.measurement.consistance.line.list</field>
        <field name="model">rail.measurement.consistance.line</field>
        <field name="arch" type="xml">
            <list string="Consistance">
                <field name="ligne_id"/>
                <field name="voie_id"/>
                <field name="desc_nature_travaux" optional="show"/>
                <field name="pkd" string="PK D." widget="float" decoration-bf="1"/>
                <field name="pkf" string="PK F." widget="float" decoration-bf="1"/>
                <!-- Use 'optional="hide"' for fields that are useful but clutter the view -->
                <field name="limite_amont" optional="hide"/>
                <field name="limite_aval" optional="hide"/>
                <field name="nombre_courbes" string="Courbes" optional="show"/>
                <field name="nombres_quais" string="Quais" optional="show"/>
                <field name="observations" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- ========== MENUS ========== -->
    <menuitem id="rail_measurement_root"
              name="Mesure de voie"
              web_icon="your_module,static/description/icon.png"
              sequence="50"/>

    <menuitem id="rail_measurement_menu_ops"
              name="Op√©rations"
              parent="rail_measurement_root"
              sequence="10"/>

    <menuitem id="rail_measurement_menu_action"
              name="Mesures de voie"
              parent="rail_measurement_menu_ops"
              action="action_rail_measurement"
              sequence="10"/>

    <menuitem id="rail_measurement_menu_resources"
              name="Ressources"
              parent="rail_measurement_root"
              sequence="20"/>

    <menuitem id="chariot_type_menu"
              name="Types de chariots"
              parent="rail_measurement_menu_resources"
              action="action_chariot_type"
              sequence="10"/>

    <menuitem id="chariot_menu"
              name="Chariots physiques"
              parent="rail_measurement_menu_resources"
              action="action_chariot"
              sequence="20"/>

</odoo>