<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- ========== ACTIONS ========== -->
    <record id="action_rail_measurement" model="ir.actions.act_window">
        <field name="name">Mesures de voie</field>
        <field name="res_model">rail.measurement</field>
        <!-- On ajoute 'calendar' ici -->
        <field name="view_mode">list,calendar,form</field>
    </record>

    <!-- ========== WIZARD: Cr√©ation de mesure ========== -->
    <record id="view_rail_measurement_wizard_form" model="ir.ui.view">
        <field name="name">rail.measurement.wizard.form</field>
        <field name="model">rail.measurement.wizard</field>
        <field name="arch" type="xml">
            <form string="Associer une mesure">
                <sheet>
                    <group>
                        <field name="mode" widget="radio"/>
                        <field name="partner_id" invisible="1"/>
                        <field name="sale_order_line_id" invisible="1"/>
                    </group>
                    
                    <!-- This part is only visible if 'Link' is selected -->
                    <group invisible="mode != 'link'">
                        <field name="measurement_id" 
                            options="{'no_create': True}" 
                            required="mode == 'link'"
                            placeholder="S√©lectionnez une mesure d√©j√† cr√©√©e..."/>
                    </group>

                    <!-- Helpful note for 'Create' mode -->
                    <div class="alert alert-info" role="alert" invisible="mode != 'create'">
                        <i class="fa fa-info-circle mr-1"/>
                        En cliquant sur <b>Valider</b>, le formulaire complet de configuration LEYFA s'ouvrira dans une nouvelle fen√™tre.
                    </div>
                </sheet>
                <footer>
                    <button name="action_apply" string="Valider" type="object" class="btn-primary"/>
                    <button string="Annuler" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- ========== WIZARD: Ligne d'affectation de chariot ========== -->
    <record id="view_assign_chariot_line_list" model="ir.ui.view">
        <field name="name">rail.measurement.assign.chariot.line.wizard.list</field>
        <field name="model">rail.measurement.assign.chariot.line.wizard</field>
        <field name="arch" type="xml">
            <list editable="bottom">
                <field name="chariot_type_id" readonly="1"/>
                <field name="chariot_id" 
                       domain="[('cart_type_id', '=', chariot_type_id), ('state', '=', 'available')]"
                       options="{'no_create': True}"/>
            </list>
        </field>
    </record>

    <!-- ========== WIZARD: Affectation des chariots ========== -->
    <record id="view_rail_measurement_assign_chariot_wizard_form" model="ir.ui.view">
        <field name="name">rail.measurement.assign.chariot.wizard.form</field>
        <field name="model">rail.measurement.assign.chariot.wizard</field>
        <field name="arch" type="xml">
            <form string="Affecter les chariots physiques">
                <sheet>
                    <group>
                        <field name="measurement_id" readonly="1"/>
                    </group>

                    <separator string="Besoins d√©finis au devis"/>
                    <field name="chariot_type_lines" readonly="1">
                        <list>
                            <field name="chariot_type_id"/>
                            <field name="quantity"/>
                        </list>
                    </field>

                    <separator string="Affecter les chariots physiques" class="mt-3"/>
                    <field name="assignment_line_ids" nolabel="1"/>
                </sheet>

                <footer>
                    <button name="action_assign" string="Affecter" type="object" class="btn-primary"/>
                    <button string="Annuler" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- ========== VIEWS: Rail Measurement ========== -->
    <record id="view_rail_measurement_list" model="ir.ui.view">
        <field name="name">rail.measurement.list</field>
        <field name="model">rail.measurement</field>
        <field name="arch" type="xml">
            <list string="Mesures de voie" 
                  decoration-info="state=='presale'" 
                  decoration-warning="state in ('production', 'measure', 'study', 'invoicing')" 
                  decoration-success="state=='done'"
                  decoration-danger="state=='cancelled'">
                <field name="reference"/>
                <field name="partner_id"/>
                <field name="date_start"/>
                <field name="ligne_id"/>
                <field name="pk_initial"/>
                <field name="pk_final"/>
                <field name="state" widget="badge" 
                       decoration-info="state == 'presale'"
                       decoration-warning="state in ('production', 'measure', 'study', 'invoicing')"
                       decoration-success="state == 'done'"
                       decoration-danger="state == 'cancelled'"/>
            </list>
        </field>
    </record>

    <record id="view_rail_measurement_form" model="ir.ui.view">
        <field name="name">rail.measurement.form</field>
        <field name="model">rail.measurement</field>
        <field name="arch" type="xml">
            <form string="Mesure de voie">
                <header>
                    <!-- Buttons and Statusbar remain here -->
                    <!-- <button name="action_confirm" string="Confirmer" type="object" invisible="state != 'presale'" class="oe_highlight"/> -->
                    <button name="action_validate_assignment" string="Valider l'affectation" type="object" invisible="state != 'confirmed' or not chariots_assigned" class="oe_highlight"/>
                    <button name="action_start" string="D√©marrer" type="object" invisible="state != 'planned'" class="oe_highlight"/>
                    <!-- <button name="action_done" string="Terminer" type="object" invisible="state != 'in_progress'" class="oe_highlight"/> -->
                    <!-- <button name="action_done" string="Terminer" type="object" class="oe_highlight"/> -->
                    <button name="action_cancel" string="Annuler" type="object" invisible="state not in ['presale', 'confirmed', 'planned', 'in_progress']"/>
                    <button name="action_reset_to_draft" string="Remettre en pr√©-vente" type="object" invisible="state != 'cancelled'"/>
                    <field name="state" widget="statusbar" statusbar_visible="presale,production,measure,study,invoicing,done"/>
                </header>
                <sheet>
                    <!-- Identification Header: Only the essential "Who" -->
                    <div class="oe_title">
                        <div class="text-muted fst-italic small">
                            <field name="reference" readonly="1" nolabel="1"/>
                        </div>
                        <label for="partner_id" string="Client"/>
                        <h2 class="d-flex">
                            <field name="partner_id" placeholder="Nom du client..." readonly="state != 'presale'"/>
                        </h2>
                    </div>

                    <notebook>
                        <!-- TAB 1: SALES / COMMERCE -->
                        <page string="üíº Affaire &amp; Commerce" name="sales_tab">
                            <!-- On ne garde qu'une seule row avec la marge n√©gative -->
                            <div class="row mt-n2" style="margin-top: 0px !important;">
                                
                                <!-- COLONNE GAUCHE (50% de largeur) -->
                                <div class="col-lg-6 col-md-12">
                                    <group string="CODAGE LEYFA" name="codage_leyfa">
                                        <field name="type_requires_nature" invisible="1"/>
                                        <field name="state" invisible="1"/>
                                        <field name="last_synced_code" invisible="1" force_save="1"/>

                                        <field name="code_affaire" 
                                            string="Code Affaire"
                                            placeholder="Entrez le code complet..." 
                                            decoration-bf="1" 
                                            class="text-primary fs-4" 
                                            readonly="state != 'presale'" 
                                            force_save="1"/>

                                        <div colspan="2" class="text-center text-muted fw-bold py-2">
                                            ‚Äî OU ‚Äî
                                        </div>

                                        <field name="exercice_id" options="{'no_create': True, 'no_open': True}" readonly="state != 'presale'"/>
                                        <label for="ligne_id" string="Ligne / Voies"/>
                                        <div class="o_row">
                                            <field name="ligne_id" 
                                                options="{'no_create': True, 'no_open': True}" 
                                                readonly="state != 'presale'"
                                                placeholder="S√©lectionnez la ligne..."/>
                                            
                                            <field name="voie_ids" 
                                                widget="many2many_tags" 
                                                options="{'color_field': 'color', 'no_create_edit': False}"
                                                placeholder="Voies..."
                                                readonly="state != 'presale'"
                                                context="{'default_active': True}"/>
                                        </div>
                                        <field name="type_affaire_id" options="{'no_create': True, 'no_open': True}" readonly="state != 'presale'"/>
                                        <field name="nature_mission" widget="radio" options="{'horizontal': true}" 
                                            invisible="not type_requires_nature" required="type_requires_nature" readonly="state != 'presale'"/>
                                        <separator string="D√âTAILS MARCH√â (EXCEL)" colspan="2" class="mt-4 mb-2" style="font-size: 0.9rem; opacity: 0.7;"/>

                                        <!-- Ligne 1 : Typologie + Nature -->
                                        <label for="desc_typologie_detail" string="Typologie / Travaux"/>
                                        <div class="o_row">
                                            <field name="desc_typologie_detail" placeholder="Typologie..." readonly="state != 'presale'"/>
                                            <field name="desc_nature_travaux" placeholder="Nature des travaux..." readonly="state != 'presale'"/>
                                        </div>

                                        <!-- Ligne 2 : M√©thodologie + Ann√©e -->
                                        <label for="desc_methodologie" string="M√©thodo / Ann√©e"/>
                                        <div class="o_row">
                                            <field name="desc_methodologie" placeholder="M√©thodologie..." readonly="state != 'presale'"/>
                                            <field name="desc_annee" options="{'format': false}" placeholder="Ann√©e" 
                                                readonly="state != 'presale'" style="width: 70px !important;"/>
                                        </div>
                                    </group>
                                </div>

                                <!-- COLONNE DROITE (50% de largeur) -->
                                <div class="col-lg-6 col-md-12">
                                    
                                    <!-- PREMIER BLOC : LOCALISATION -->
                                    <group string="LOCALISATION" name="localisation_group">
                                        <label for="pk_initial" string="Segment (PK)"/>
                                        <div class="o_row">
                                            <field name="pk_initial" placeholder="D√©but" readonly="state != 'presale'"/>
                                            <span>√†</span>
                                            <field name="pk_final" placeholder="Fin" readonly="state != 'presale'"/>
                                        </div>
                                        <label for="lineaire_releve" string="Lin√©aire relev√©"/>
                                        <div class="o_row">
                                            <field name="lineaire_releve" 
                                                placeholder="M√©trage..."
                                                readonly="state not in ['presale', 'measure']"
                                                class="oe_inline"
                                                style="width: 100px !important;"/>
                                        </div>

                                        <label for="lineaire_etudes" string="Lin√©aire √©tudes" invisible="nature_mission != 'E'"/>
                                        <div class="o_row">
                                            <field name="lineaire_etudes" 
                                                placeholder="M√©trage..."
                                                readonly="state not in ['presale', 'study']"
                                                class="oe_inline"
                                                style="width: 100px !important;"
                                                invisible="nature_mission != 'E'"/>
                                        </div>
                                    </group>

                                    <!-- DEUXI√àME BLOC : VENTE -->
                                    <group string="VENTE" name="ventes_group">
                                        
                                        <!-- CONTENEUR FLEX : Force tout sur une seule ligne -->
                                        <div colspan="2" class="text-muted mb-2 d-flex align-items-center" 
                                            style="font-size: 0.72rem; border-bottom: 1px solid #eee; padding-bottom: 5px; white-space: nowrap; overflow: hidden;" 
                                            invisible="not sale_order_id">
                                            
                                            <!-- Bloc R√©f -->
                                            <div class="d-flex align-items-center me-2">
                                                <span class="fw-bold me-1">R√©f :</span>
                                                <field name="sale_order_id" readonly="1" nolabel="1" class="oe_inline m-0"/>
                                            </div>

                                            <span class="me-2 text-silver">|</span>

                                            <!-- Bloc Ligne : flex-grow-1 et overflow hidden permettent de couper le texte si trop long -->
                                            <div class="d-flex align-items-center flex-grow-1" style="min-width: 0; overflow: hidden;">
                                                <span class="fw-bold me-1">Ligne :</span>
                                                <field name="sale_order_line_id" readonly="1" nolabel="1" class="oe_inline m-0" 
                                                    style="overflow: hidden; text-overflow: ellipsis;"/>
                                            </div>
                                        </div>
                                        <field name="currency_id" invisible="1"/>
                                        <field name="total_nb_periods" invisible="1"/>

                                        <!-- LIGNE 1 : RELEV√â (Toujours visible) -->
                                        <label for="price_releve"/>
                                        <div class="d-flex align-items-baseline">
                                            <field name="price_releve" widget="monetary" class="oe_inline fw-bold"
                                                readonly="state != 'presale'" options="{'currency_field': 'currency_id'}"/>
                                            
                                            <div class="text-muted small ms-2" invisible="total_nb_periods == 0">
                                                <span>(</span>
                                                <field name="price_releve_daily" widget="monetary" class="oe_inline"/>
                                                <span> / p√©r.)</span>
                                            </div>
                                        </div>

                                        <!-- LIGNE 2 : √âTUDES (Visible seulement si 'E') -->
                                        <label for="price_etudes" invisible="nature_mission != 'E'"/>
                                        <div class="d-flex align-items-baseline" invisible="nature_mission != 'E'">
                                            <field name="price_etudes" widget="monetary" class="oe_inline fw-bold"
                                                readonly="state != 'presale'" options="{'currency_field': 'currency_id'}"/>
                                            
                                            <div class="text-muted small ms-2" invisible="total_nb_periods == 0">
                                                <span>(</span>
                                                <field name="price_etudes_daily" widget="monetary" class="oe_inline"/>
                                                <span> / p√©r.)</span>
                                            </div>
                                        </div>
                                        
                                        <label for="price_total" string="Total Mission" invisible="nature_mission != 'E'"/>
                                        <div class="d-flex align-items-baseline" invisible="nature_mission != 'E'">
                                            <field name="price_total" widget="monetary" class="oe_inline fw-bold text-primary"
                                                readonly="1" options="{'currency_field': 'currency_id'}"/>
                                            
                                            <div class="text-primary small ms-2" invisible="total_nb_periods == 0">
                                                <span class="fw-bold">(Œ£ </span>
                                                <field name="price_total_daily" widget="monetary" class="oe_inline"/>
                                                <span> / p√©r.)</span>
                                            </div>
                                        </div>
                                    </group>
                                    
                                </div> <!-- Fin de la colonne droite -->
                            </div> <!-- Fin de la row -->
                        </page>

                        <!-- TAB 2: PRODUCTION / TERRAIN -->
                        <page string="üèóÔ∏è Planification &amp; Terrain" name="production_tab">
                            <group string="CALENDRIER &amp; √âQUIPE">
                                <!-- L'affichage des semaines en grand -->
                                <label for="display_weeks" string="P√©riode :"/>
                                <div class="o_row align-items-baseline">
                                    <!-- 1. Le titre en gros (SXX/XX) -->
                                    <field name="display_weeks" readonly="1" class="fw-bold fs-4 text-primary me-3"/>
                                    
                                    <!-- 2. Le s√©lecteur de dates (discret entre parenth√®ses) -->
                                    <span class="text-muted small">(Ajuster : </span>
                                    
                                    <!-- Le widget est port√© par date_start. 
                                        Il affichera de lui-m√™me "Date1 -> Date2" √† cet endroit pr√©cis -->
                                    <field name="date_start" 
                                        widget="daterange" 
                                        options="{'end_date_field': 'date_end'}"
                                        class="small oe_inline m-0 p-0"
                                        force_save="1"/>

                                    <!-- CORRECTION : On utilise class="d-none" au lieu de invisible="1" -->
                                    <!-- Cela permet au widget de "lier" les deux champs d√®s le chargement -->
                                    <field name="date_end" class="d-none" force_save="1"/>
                                    
                                    <span class="text-muted small">)</span>

                                    <!-- 3. Ton bouton de g√©n√©ration -->
                                    <button name="action_generate_planning" type="object" 
                                            string="G√©n√©rer les semaines" 
                                            class="btn-outline-primary btn-sm ms-3" 
                                            icon="fa-refresh"
                                            invisible="not date_start or not date_end"/>
                                </div>
                                
                                <label for="team_ids" string="√âquipe "/>
                                <div class="o_row">
                                    <field name="team_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                                    <!-- <span>Chef :</span>
                                    <field name="team_leader_id" widget="many2one_avatar_user"/> -->
                                </div>
                                <!-- Bouton pour g√©n√©rer les lignes si les dates ont chang√© -->
                            </group>
                            <separator string="PLANNING JOURNALIER (J/N)"/>

                            <!-- On utilise une div pour limiter la largeur (ex: col-7 pour environ 60% de l'√©cran) -->
                            <div class="row">
                                <div class="col-lg-7 col-md-4">
                                    <field name="planning_ids" mode="list" nolabel="1">
                                        <!-- 'delete="0"' pour enlever la corbeille et 'planning-grid' pour le CSS -->
                                        <list editable="bottom" create="0" delete="0" class="planning-grid">
                                            
                                            <field name="week_label" readonly="1" class="fw-bold text-center" header_class="text-center"/>

                                            <field name="date_from" string="Du" readonly="1" 
                                                class="small text-muted text-center" 
                                                header_class="text-muted fw-normal text-center"/>

                                            <field name="date_to" string="Au" readonly="1" 
                                                class="small text-muted text-center" 
                                                header_class="text-muted fw-normal text-center"/>

                                            <!-- On utilise les d√©corations standards pour d√©clencher les couleurs CSS -->
                                            <field name="mon" string="L" class="text-center" header_class="text-center"
                                                decoration-warning="mon == 'day'" decoration-success="mon == 'night'"/>
                                            <field name="tue" string="M" class="text-center" header_class="text-center"
                                                decoration-warning="tue == 'day'" decoration-success="tue == 'night'"/>
                                            <field name="wed" string="M" class="text-center" header_class="text-center"
                                                decoration-warning="wed == 'day'" decoration-success="wed == 'night'"/>
                                            <field name="thu" string="J" class="text-center" header_class="text-center"
                                                decoration-warning="thu == 'day'" decoration-success="thu == 'night'"/>
                                            <field name="fri" string="V" class="text-center" header_class="text-center"
                                                decoration-warning="fri == 'day'" decoration-success="fri == 'night'"/>
                                            <field name="sat" string="S" class="text-center" header_class="text-center"
                                                decoration-warning="sat == 'day'" decoration-success="sat == 'night'"/>
                                            <field name="sun" string="D" class="text-center" header_class="text-center"
                                                decoration-warning="sun == 'day'" decoration-success="sun == 'night'"/>
                                                                                        
                                            <button name="action_copy_to_all" 
                                                type="object" 
                                                icon="fa-clone" 
                                                title="Appliquer ce r√©gime √† toutes les semaines" 
                                                class="text-primary btn_copy_row"/>
                                        </list>
                                    </field>
                                </div>
                            </div>
                            <div class="text-muted small mt-1 ps-2" invisible="not planning_ids">
                                <i class="fa fa-info-circle me-1"/>
                                <span>Nombre de p√©riodes : </span>
                                <field name="total_nb_periods" class="fw-bold"/>
                                <span class="ms-1">(J/N)</span>
                            </div>                                          
                            <separator string="RESSOURCES CHARIOTS"/>
                            <div class="alert alert-info" role="status" invisible="state != 'production' or prod_substate == 'assigned'">
                                <i class="fa fa-info-circle" title="Information"/> <b>Action requise :</b> Affectez les chariots physiques pour les dates s√©lectionn√©es.
                            </div>
                            <field name="chariot_type_lines" readonly="state in ['done', 'cancelled']">
                                <list editable="bottom">
                                    <field name="chariot_type_id" options="{'no_create': True}" readonly="parent.state != 'presale'"/>
                                    <field name="quantity" readonly="parent.state != 'presale'"/>
                                    <field name="assigned_chariot_ids" 
                                        widget="many2many_tags" 
                                        options="{'no_create': True, 'color_field': 'state'}"
                                        
                                        domain="[('cart_type_id', '=', chariot_type_id)]"
                                        
                                        context="{
                                            'check_avail_start': parent.date_start,
                                            'check_avail_end': parent.date_end,
                                            'check_avail_id': parent.id
                                        }"
                                        
                                        placeholder="S√©lectionnez les chariots..."
                                        readonly="parent.state != 'production' or parent.prod_substate == 'assigned' or not parent.date_start or not parent.date_end"
                                        />
                                </list>
                            </field>
                        </page>

                        <!-- TAB 3: √âTUDES & RAPPORTS -->
                        <page string="üî¨ √âtudes &amp; Livrables" name="studies_tab">
                            <group>
                                <group string="DONN√âES BRUTES">
                                    <field name="measurement_filename" invisible="1"/>
                                    <field name="measurement_file" filename="measurement_filename" widget="binary"/>
                                </group>
                            </group>
                            <separator string="RAPPORT D'INTERVENTION"/>
                            <field name="report" widget="html" placeholder="Saisissez ici les conclusions de l'√©tude..."/>
                            <separator string="NOTES INTERNES"/>
                            <field name="notes" placeholder="Notes diverses, incidents terrain..."/>
                        </page>

                        <!-- TAB 4: PROCESS VISUALISATION -->
                        <page string="‚öôÔ∏è Visualisation du processus" name="process_tab">
                            <group>
                                <group string="Configuration">
                                    <field name="view_level" widget="selection"/>
                                    <!-- <field name="urgent_material_needed" widget="boolean_toggle" invisible="state != 'production'"/> -->
                                </group>
                                <group string="Sous-√©tapes">
                                    <field name="sale_substate" invisible="state != 'presale'" readonly="1"/>
                                    <field name="prod_substate" invisible="state != 'production'" readonly="1"/>
                                    <field name="measure_substate" invisible="state != 'measure'" readonly="1"/>
                                    <field name="study_substate" invisible="state != 'study'" readonly="1"/>
                                </group>
                            </group>
                            <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                                <field name="mermaid_graph" widget="mermaid" nolabel="1"/>
                                <div class="mt-1" invisible="not state_tip">
                                    <field name="state_tip" nolabel="1"/>
                                </div>
                            </div>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ========== PRODUCT TEMPLATE VIEWS ========== -->
    <record id="product_template_form_view_rail" model="ir.ui.view">
        <field name="name">product.template.form.rail</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                <page string="Mesure Ferroviaire" name="rail_measurement">
                    <group>
                        <group>
                            <field name="is_rail_measurement"/>
                        </group>
                    </group>

                    <separator string="Suivi des prestations" class="mt-4"/>
                    
                    <div class="alert alert-info" role="alert" invisible="rail_measurement_count == 0">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <strong><field name="rail_measurement_count"/></strong> mesure(s) r√©alis√©e(s) avec ce produit.
                            </div>
                            <button name="action_view_rail_measurements" 
                                    type="object" 
                                    string="Voir les mesures" 
                                    class="btn btn-primary btn-sm"
                                    icon="fa-list"/>
                        </div>
                    </div>
                    
                    <div invisible="rail_measurement_count > 0" class="text-muted">
                        <i>Aucune mesure enregistr√©e pour ce produit pour le moment.</i>
                    </div>
                </page>
            </xpath>
        </field>
    </record>

    <!-- ========== SALE ORDER VIEWS ========== -->
    <record id="view_order_form_rail" model="ir.ui.view">
        <field name="name">sale.order.form.rail</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_measurements" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-train" 
                        invisible="measurement_count == 0">
                    <field name="measurement_count" widget="statinfo" string="Mesures"/>
                </button>
            </xpath>

            <xpath expr="//field[@name='order_line']/list" position="inside">
                <field name="is_rail_measurement" column_invisible="1"/>
                <field name="rail_measurement_id" column_invisible="1"/>
                <field name="is_main_measurement_line" column_invisible="1"/>

                <button name="action_create_rail_measurement" 
                        type="object" 
                        icon="fa-plus-square" 
                        title="Cr√©er Mesure"
                        invisible="not is_rail_measurement or rail_measurement_id"/>
                
                <button name="action_open_rail_measurement_form" 
                        type="object" 
                        icon="fa-train" 
                        title="Ouvrir Mesure"
                        save="0"
                        invisible="not is_rail_measurement or not rail_measurement_id"/>
                
                <button name="action_remove_rail_measurement" 
                        type="object" 
                        icon="fa-times" 
                        title="D√©tacher Mesure"
                        save="0"
                        invisible="not is_rail_measurement or not rail_measurement_id or parent.state != 'draft' or not is_main_measurement_line"/>
            </xpath>
        </field>
    </record>

    <!-- ========== CHARIOT VIEWS ========== -->
    <record id="view_chariot_list" model="ir.ui.view">
        <field name="name">chariot.list</field>
        <field name="model">chariot</field>
        <field name="arch" type="xml">
            <list string="Chariots" 
                  decoration-success="state=='available'" 
                  decoration-danger="state=='out_of_service'" 
                  decoration-warning="state=='maintenance'">
                <field name="name"/>
                <field name="cart_type_id"/>
                <field name="serial_number"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'available'"
                       decoration-warning="state == 'maintenance'"
                       decoration-danger="state == 'out_of_service'"/>
            </list>
        </field>
    </record>

    <record id="view_chariot_form" model="ir.ui.view">
        <field name="name">chariot.form</field>
        <field name="model">chariot</field>
        <field name="arch" type="xml">
            <form string="Chariot">
                <header>
                    <field name="state" widget="statusbar" options="{'clickable': '1'}"/>
                </header>
                <sheet>
                    <!-- C'est ici que manquait la "button_box" -->
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" 
                                name="action_view_calendar" 
                                icon="fa-calendar">
                            <div class="o_stat_info">
                                <span class="o_stat_text">Planning</span>
                            </div>
                        </button>
                    </div>

                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1><field name="name" placeholder="Ex: Chariot A-12"/></h1>
                    </div>
                    <group>
                        <group>
                            <field name="cart_type_id"/>
                            <field name="serial_number"/>
                        </group>
                        <group>
                            <field name="active" widget="boolean_toggle"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Historique des mesures">
                            <field name="measurement_ids" readonly="1">
                                <list>
                                    <field name="reference"/>
                                    <field name="date_start"/>
                                    <field name="state"/>
                                </list>
                            </field>
                        </page>
                        <page string="Notes">
                            <field name="notes"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_chariot" model="ir.actions.act_window">
        <field name="name">Chariots</field>
        <field name="res_model">chariot</field>
        <field name="view_mode">list,form</field>
    </record>

    <!-- ========== CHARIOT TYPE VIEWS ========== -->
    <record id="view_chariot_type_list" model="ir.ui.view">
        <field name="name">chariot.type.list</field>
        <field name="model">chariot.type</field>
        <field name="arch" type="xml">
            <list string="Types de chariots">
                <field name="name" string="Type de chariot"/>
                <field name="manufacturer"/>
            </list>
        </field>
    </record>

    <record id="view_chariot_type_form" model="ir.ui.view">
        <field name="name">chariot.type.form</field>
        <field name="model">chariot.type</field>
        <field name="arch" type="xml">
            <form string="Type de chariot">
                <sheet>
                    <group>
                        <field name="name"/>
                        <field name="manufacturer"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_chariot_type" model="ir.actions.act_window">
        <field name="name">Types de chariots</field>
        <field name="res_model">chariot.type</field>
        <field name="view_mode">list,form</field>
    </record>

    <record id="view_rail_measurement_calendar" model="ir.ui.view">
        <field name="name">rail.measurement.calendar</field>
        <field name="model">rail.measurement</field>
        <field name="arch" type="xml">
            <calendar string="Planning des mesures" 
                      date_start="date_start" 
                      date_stop="date_end"
                      color="state"
                      mode="month">
                <field name="reference"/>
                <field name="partner_id"/>
                <field name="assigned_chariot_ids" widget="many2many_tags"/>
            </calendar>
        </field>
    </record>

    <!-- ========== MENUS ========== -->
    <menuitem id="rail_measurement_root"
              name="Mesure de voie"
              web_icon="your_module,static/description/icon.png"
              sequence="50"/>

    <menuitem id="rail_measurement_menu_ops"
              name="Op√©rations"
              parent="rail_measurement_root"
              sequence="10"/>

    <menuitem id="rail_measurement_menu_action"
              name="Mesures de voie"
              parent="rail_measurement_menu_ops"
              action="action_rail_measurement"
              sequence="10"/>

    <menuitem id="rail_measurement_menu_resources"
              name="Ressources"
              parent="rail_measurement_root"
              sequence="20"/>

    <menuitem id="chariot_type_menu"
              name="Types de chariots"
              parent="rail_measurement_menu_resources"
              action="action_chariot_type"
              sequence="10"/>

    <menuitem id="chariot_menu"
              name="Chariots physiques"
              parent="rail_measurement_menu_resources"
              action="action_chariot"
              sequence="20"/>

</odoo>