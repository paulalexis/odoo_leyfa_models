<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_rail_measurement_form_inherit_planification" model="ir.ui.view">
        <field name="name">rail.measurement.form.inherit.planification</field>
        <field name="model">rail.measurement</field>
        <field name="inherit_id" ref="rail_measurement.view_rail_measurement_form"/>
        <field name="arch" type="xml">
            
            <!-- We target the notebook in the main view -->
            <xpath expr="//page[@name='planification_tab']" position="inside">
                <group string="CALENDRIER &amp; ÉQUIPE">
                    <!-- L'affichage des semaines en grand -->
                    <label for="display_weeks" string="Période :"/>
                    <div class="o_row align-items-baseline">
                        <!-- 1. Le titre en gros (SXX/XX) -->
                        <field name="display_weeks" readonly="1" class="fw-bold fs-4 text-primary me-3"/>
                        
                        <!-- 2. Le sélecteur de dates (discret entre parenthèses) -->
                        <span class="text-muted small">(Ajuster : </span>
                        
                        <!-- Le widget est porté par date_start. 
                            Il affichera de lui-même "Date1 -> Date2" à cet endroit précis -->
                        <field name="date_start" 
                            widget="daterange" 
                            options="{'end_date_field': 'date_end'}"
                            class="small oe_inline m-0 p-0"
                            force_save="1"
                            readonly="state != 'presale' and (state != 'production' or prod_substate != 'mission')"/>

                        <!-- CORRECTION : On utilise class="d-none" au lieu de invisible="1" -->
                        <!-- Cela permet au widget de "lier" les deux champs dès le chargement -->
                        <field name="date_end" class="d-none" force_save="1" readonly="state != 'presale' and (state != 'production' or prod_substate != 'mission')"/>
                        
                        <span class="text-muted small">)</span>

                        <!-- 3. Ton bouton de génération -->
                        <button name="action_generate_planning" type="object" 
                                string="Générer les semaines" 
                                class="btn-outline-primary btn-sm ms-3" 
                                icon="fa-refresh"
                                invisible="not date_start or not date_end"/>
                    </div>
                    
                    <label for="team_ids" string="Équipe "/>
                    <div class="o_row">
                        <field name="team_ids" widget="many2many_tags" options="{'color_field': 'color'}" readonly="state != 'presale' and (state != 'production' or prod_substate != 'mission')"/>
                        <!-- <span>Chef :</span>
                        <field name="team_leader_id" widget="many2one_avatar_user"/> -->
                    </div>
                    <!-- Bouton pour générer les lignes si les dates ont changé -->
                </group>
                <separator string="PLANNING JOURNALIER (J/N)"/>

                <!-- On utilise une div pour limiter la largeur (ex: col-7 pour environ 60% de l'écran) -->
                <div class="row">
                    <div class="col-lg-7 col-md-4">
                        <field name="planning_ids" mode="list" nolabel="1" readonly="state != 'presale' and (state != 'production' or prod_substate != 'mission')">
                            <!-- 'delete="0"' pour enlever la corbeille et 'planning-grid' pour le CSS -->
                            <list editable="bottom" create="0" delete="0" class="planning-grid">
                                
                                <field name="week_label" readonly="1" class="fw-bold text-center" header_class="text-center"/>

                                <field name="date_start" string="Du" readonly="1" 
                                    class="small text-muted text-center" 
                                    header_class="text-muted fw-normal text-center"/>

                                <field name="date_end" string="Au" readonly="1" 
                                    class="small text-muted text-center" 
                                    header_class="text-muted fw-normal text-center"/>

                                <!-- On utilise les décorations standards pour déclencher les couleurs CSS -->
                                <field name="mon" string="L" class="text-center" header_class="text-center"
                                    decoration-warning="mon == 'day'" decoration-success="mon == 'night'"/>
                                <field name="tue" string="M" class="text-center" header_class="text-center"
                                    decoration-warning="tue == 'day'" decoration-success="tue == 'night'"/>
                                <field name="wed" string="M" class="text-center" header_class="text-center"
                                    decoration-warning="wed == 'day'" decoration-success="wed == 'night'"/>
                                <field name="thu" string="J" class="text-center" header_class="text-center"
                                    decoration-warning="thu == 'day'" decoration-success="thu == 'night'"/>
                                <field name="fri" string="V" class="text-center" header_class="text-center"
                                    decoration-warning="fri == 'day'" decoration-success="fri == 'night'"/>
                                <field name="sat" string="S" class="text-center" header_class="text-center"
                                    decoration-warning="sat == 'day'" decoration-success="sat == 'night'"/>
                                <field name="sun" string="D" class="text-center" header_class="text-center"
                                    decoration-warning="sun == 'day'" decoration-success="sun == 'night'"/>
                                                                            
                                <button name="action_copy_to_all" 
                                    type="object" 
                                    icon="fa-clone" 
                                    title="Appliquer ce régime à toutes les semaines" 
                                    class="text-primary btn_copy_row"
                                    invisible="parent.state != 'presale' and (parent.state != 'production' or parent.prod_substate != 'mission')"/>
                            </list>
                        </field>
                    </div>
                </div>
                <div class="text-muted small mt-1 ps-2" invisible="not planning_ids">
                    <i class="fa fa-info-circle me-1"/>
                    <span>Nombre de périodes : </span>
                    <field name="total_nb_periods" class="fw-bold"/>
                    <span class="ms-1">(J/N)</span>
                </div>                                          
                <separator string="RESSOURCES CHARIOTS"/>
                <div class="alert alert-info" role="status" invisible="state != 'presale' and (state != 'production' or prod_substate not in ['material'])">
                    <i class="fa fa-info-circle" title="Information"/> <b>Action requise :</b> Affectez les chariots physiques pour les dates sélectionnées.
                </div>
                <div class="alert alert-info" role="status" invisible="(state != 'production' or prod_substate not in ['mission'])">
                    <i class="fa fa-info-circle" title="Information"/> <b>Action requise :</b> Remplissez le besoin en chariots pour les dates sélectionnées.
                </div>
                <field name="chariot_type_lines" 
                    readonly="state != 'presale' and (state != 'production' or prod_substate not in ['mission', 'material'])">
                    <list editable="bottom">
                        <field name="chariot_type_id" 
                            options="{'no_create': True}"
                            domain="[('id', 'not in', parent.existing_chariot_type_ids)]"
                            force_save="1"
                            readonly="parent.state != 'presale' and (parent.state != 'production' or parent.prod_substate not in ['mission'])"/>
                        <field name="quantity" readonly="parent.state != 'presale' and (parent.state != 'production' or parent.prod_substate not in ['mission'])"/>
                        <field name="assigned_chariot_ids" 
                            widget="many2many_tags" 
                            options="{'no_create': True, 'color_field': 'state'}"
                            
                            domain="[('cart_type_id', '=', chariot_type_id)]"
                            
                            context="{
                                'check_avail_start': parent.date_start,
                                'check_avail_end': parent.date_end,
                                'check_avail_id': parent.id
                            }"
                            
                            placeholder="Sélectionnez les chariots..."
                            readonly="(parent.state != 'presale' and (parent.state != 'production' or parent.prod_substate not in ['material'])) or not parent.date_start or not parent.date_end"
                            />
                    </list>
                </field>
            </xpath>
        </field>
    </record>
</odoo>